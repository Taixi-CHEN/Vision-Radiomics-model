# 图像-radiomics相似性预训练配置文件
# 这个文件只包含需要覆盖的配置，基础配置从 biomed_seg_lang_v1.yaml 加载

# Define Test/Trainer/Saving
PIPELINE: XDecoderPipeline
TRAINER: xdecoder
SAVE_DIR: './output'
base_path: "./"

# Resume Logistic
RESUME: false
WEIGHT: false
RESUME_FROM: ''
EVAL_AT_START: false
SAVE_CHECKPOINT: True

# Logging and Debug
WANDB: TRUE
LOG_EVERY: 100
FIND_UNUSED_PARAMETERS: false

# Speed up training
FP16: true
PORT: '36873'

# misc
LOADER:
  JOINT: True
  KEY_DATASET: ""
  SAMPLE_PROB: "prop"
  MIXING_LEVEL: 1

RANDOM_SEED: 2024
STANDARD_TEXT_FOR_EVAL: False
VERBOSE: true

# 只覆盖必要的字段，不覆盖整个 MODEL 部分
MODEL:
  NAME: "seem_model_v1_radiomics"  # 使用注册的radiomics模型
  HEAD: xdecoder_head
  MASK_ON: false
  KEYPOINT_ON: false
  LOAD_PROPOSALS: false
  DIM_PROJ: 512
  TEXT:
    ARCH: vlpencoder
    NAME: transformer
    TOKENIZER: clip
    CONTEXT_LENGTH: 77
    WIDTH: 512
    HEADS: 8
    LAYERS: 12
    AUTOGRESSIVE: True
  BACKBONE:
    NAME: focal
    PRETRAINED: ''
    LOAD_PRETRAINED: false
    FOCAL:
      PRETRAIN_IMG_SIZE: 224
      PATCH_SIZE: 4
      EMBED_DIM: 192
      DEPTHS: [2, 2, 18, 2]
      FOCAL_LEVELS: [4, 4, 4, 4]
      FOCAL_WINDOWS: [3, 3, 3, 3]
      DROP_PATH_RATE: 0.3
      MLP_RATIO: 4.0
      DROP_RATE: 0.0
      PATCH_NORM: True
      USE_CONV_EMBED: True
      SCALING_MODULATOR: True
      USE_CHECKPOINT: False
      USE_POSTLN: true
      USE_POSTLN_IN_MODULATION: false
      USE_LAYERSCALE: True
      OUT_FEATURES: ["res2", "res3", "res4", "res5"]
      OUT_INDICES: [0, 1, 2, 3]
  ENCODER:
    NAME: transformer_encoder_fpn
    IGNORE_VALUE: 255
    NUM_CLASSES: 2
    BINARY_CLASSES: False
    LOSS_WEIGHT: 1.0
    CONVS_DIM: 512
    MASK_DIM: 512
    NORM: "GN"
    IN_FEATURES: ["res2", "res3", "res4", "res5"]
    DEFORMABLE_TRANSFORMER_ENCODER_IN_FEATURES: ["res3", "res4", "res5"]
    COMMON_STRIDE: 4
    TRANSFORMER_ENC_LAYERS: 6
  DECODER:
    NAME: seem_v1
    TRANSFORMER_IN_FEATURE: "multi_scale_pixel_decoder"
    MASK:
      ENABLED: True
    DETECTION: False
    SPATIAL:
      ENABLED: True
      MAX_ITER: 1
    GROUNDING:
      ENABLED: True
      MAX_LEN: 10
      TEXT_WEIGHT: 2.0
      CLASS_WEIGHT: 0.5
    RETRIEVAL:
      ENABLED: False
    LVIS:
      ENABLED: False
      THRES: 0.7
    OPENIMAGE:
      ENABLED: False
      NEGATIVE_SAMPLES: 5
      GROUNDING:
        ENABLED: False
        MAX_LEN: 5
    CAPTION:
      ENABLED: False
      PHRASE_PROB: 0.5
      SIM_THRES: 0.95
    DEEP_SUPERVISION: True
    NO_OBJECT_WEIGHT: 0.1
    GCLASS_WEIGHT: 0.4
    GMASK_WEIGHT: 1.0
    GDICE_WEIGHT: 1.0
    SCLASS_WEIGHT: 0.4
    SMASK_WEIGHT: 1.0
    SDICE_WEIGHT: 1.0
    OCLASS_WEIGHT: 0.4
    OMASK_WEIGHT: 1.0
    ODICE_WEIGHT: 1.0
    CLASS_WEIGHT: 2.0
    MASK_WEIGHT: 5.0
    DICE_WEIGHT: 5.0
    BBOX_WEIGHT: 5.0
    GIOU_WEIGHT: 2.0
    CAPTION_WEIGHT: 2.0
    COST_SPATIAL:
      CLASS_WEIGHT: 5.0
      MASK_WEIGHT: 2.0
      DICE_WEIGHT: 2.0
    HIDDEN_DIM: 512
    NUM_OBJECT_QUERIES: 101
    NHEADS: 8
    DROPOUT: 0.0
    DIM_FEEDFORWARD: 2048
    MAX_SPATIAL_LEN: [512, 512, 512, 512]
    PRE_NORM: False
    ENFORCE_INPUT_PROJ: False
    SIZE_DIVISIBILITY: 32
    TRAIN_NUM_POINTS: 12544
    OVERSAMPLE_RATIO: 3.0
    IMPORTANCE_SAMPLE_RATIO: 0.75
    DEC_LAYERS: 10
    TOP_GROUNDING_LAYERS: 10
    TOP_CAPTION_LAYERS: 10
    TOP_SPATIAL_LAYERS: 10
    TOP_OPENIMAGE_LAYERS: 10
    TEST:
      SEMANTIC_ON: False
      INSTANCE_ON: False
      PANOPTIC_ON: False
      OVERLAP_THRESHOLD: 0.8
      OBJECT_MASK_THRESHOLD: 0.8
      SEM_SEG_POSTPROCESSING_BEFORE_INFERENCE: true

# Radiomics 配置
RADIOMICS:
  FEATURE_DIM: 16
  SEQ_LENGTH: 8
  JAMBA_MODEL_PATH: "modeling/architectures/G_Jamba/Jamba/jamba_model.pth"

# 预训练模式配置
PRETRAIN_MODE: True
SIMILARITY_WEIGHT: 1.0
CONSISTENCY_WEIGHT: 0.5

DATASETS:
  TRAIN: ["biomed_LUAD_WSSS_train_radiomics"]
  TEST: ["biomed_LUAD_WSSS_test_radiomics"]

INPUT:
  PIXEL_MEAN: [123.675, 116.280, 103.530]
  PIXEL_STD: [58.395, 57.120, 57.375]
  DATASET_MAPPER_NAME: "radiomics_interactive"
  MIN_SIZE_TRAIN: [640, 672, 704, 736, 768, 800]
  MAX_SIZE_TRAIN: 1333
  MIN_SIZE_TEST: 800
  MAX_SIZE_TEST: 1333

DATALOADER:
  FILTER_EMPTY_ANNOTATIONS: False
  NUM_WORKERS: 4
  LOAD_PROPOSALS: False
  SAMPLER_TRAIN: "TrainingSampler"
  ASPECT_RATIO_GROUPING: True
  IMGS_PER_BATCH: 2  # 预训练使用较小的batch size

SOLVER:
  IMS_PER_BATCH: 2
  BASE_LR: 1e-4  # 预训练学习率
  STEPS: [40000, 60000]
  MAX_ITER: 80000
  WARMUP_ITERS: 1000
  WARMUP_FACTOR: 0.001
  WEIGHT_DECAY: 1e-5
  GAMMA: 0.1
  CHECKPOINT_PERIOD: 5000

OUTPUT_DIR: "./pretrain_output"

# 预训练特定配置
PRETRAIN:
  ENABLED: True
  MAX_EPOCHS: 10
  SAVE_INTERVAL: 10
  SIMILARITY_METHOD: "cosine"
  TEMPERATURE: 0.07
  LEARNING_RATE: 1e-4
  WEIGHT_DECAY: 1e-5
  GRADIENT_CLIP_NORM: 1.0

# 数据增强
AUGMENTATION:
  ENABLED: True
  RANDOM_FLIP: "horizontal"
  RANDOM_ROTATION: 10
  COLOR_JITTER: 0.1

# 日志配置
LOGGING:
  LEVEL: "INFO"
  SAVE_INTERVAL: 100
  PRINT_INTERVAL: 10
